window.addEventListener("load",function() {
  if ($('#heart-core').length !== 1) return;

  var Q = window.Q = Quintus({ imagePath: "/assets/", dataPath: "/assets/", development: true })
          .include("Sprites, Scenes, Input, 2D, UI, Anim")
          .setup("heart-core");

  Q.getActiveStage = function () {
    return Q.stages[0];
  };

  var SPRITE_PLAYER = 1;
  var SPRITE_TILES = 2;
  var SPRITE_ENEMY = 4;
  var SPRITE_DOT = 8;

  Q.input.keyboardControls();
  Q.input.joypadControls();

  Q.gravityY = 0;
  Q.gravityX = 0;

  Q.TileLayer.extend("Map", {
    dataAsset: 'overworld.json'
  });

  Q.TileLayer.extend("Room", {
      init: function (p) {
          this._super(p);

          this.add("tween");
      }
  });

  Q.Sprite.extend("Player", {
    init: function(p) {

      this._super(p,{
        sheet:"player",
        type: SPRITE_PLAYER,
        collisionMask: SPRITE_TILES | SPRITE_ENEMY | SPRITE_DOT
      });

      this.add("2d, stepControls");
      this.on("step", this.post_state);
    },

    /* if the player leaves the scene, we stage the next scene */
    post_state: function () {
      Q.state.set("x", this.p.x);
      var stage = Q.getActiveStage();
      var background = stage.getBackground();

      if (background && background.c && background.c.w < this.p.x) {
        stage.remove(this);
        this.p.x = 0;

        var room = new Q.Room({
            dataAsset: 'zelda_test.tmx',
            layerIndex: 0,
            sheet: 'zelda',
            tileW: 32,
            tileH: 32,
            x: background.c.w,
            y: 0,
            type: Q.SPRITE_NONE
        });

        stage.insert(room);

        room.animate({ x: 0, y: 0 });
        background.animate({ x: -background.c.w, y: 0 });
      }
    }
  });

  Q.UI.Text.extend("Debug", {
    init: function (p) {
      this._super(p);

      Q.state.on("change.x", this.update);
    },

    update: function (dt) {
      this.p.label = "Lives x " + Q.state.get("x");
    }
  });
  
  Q.scene("debugger", function(stage) {
      var statsContainer = stage.insert(new Q.UI.Container({
          fill: "gray",
          x: Q.width - 70,
          y: 70,
          border: 1,
          shadow: 3,
          shadowColor: "rgba(0,0,0,0.5)",
          w: 70,
          h: 70
          })
      );
          
      var lives = stage.insert(new Q.Debug({ 
              label: "Lives x 3",
              color: "white",
              x: -300,
              y: 0
          }),statsContainer);
  });

  Q.scene("overworld",function(stage) {
    stage.p = {};

    var background = new Q.Room({ dataAsset: 'zelda_test.tmx', layerIndex: 0, sheet: 'zelda', tileW: 32, tileH: 32, type: Q.SPRITE_NONE });
    stage.insert(background);
    stage.p.background = background;

    var player = stage.insert(new Q.Player({ x: 4*32 + 16, y: 5*32 + 16 }));

    stage.getBackground = function () {
      return this.p.background;
    };
  });

  Q.scene("level2",function(stage) {
    stage.p = {};

    var background = new Q.TileLayer({ dataAsset: 'zelda_test.tmx', layerIndex: 0, sheet: 'zelda', tileW: 32, tileH: 32, type: Q.SPRITE_NONE });
    stage.insert(background);
    stage.p.background = background;

    var player = stage.insert(new Q.Player({ x: 8*32 + 16, y: 5*32 + 16 }));
  });

  Q.load("zelda.png, zelda_test.tmx, sprites.png, sprites.json, level.json", function() {
    Q.compileSheets("sprites.png","sprites.json");
    Q.sheet("zelda","zelda.png", { tilew: 32, tileh: 32});
    Q.sheet("zelda.png");
    Q.stageScene("overworld");
    Q.stageScene("debugger", 1);
  });
});

